{"version":3,"sources":["../../../src/panels/call-to-action/module.js"],"names":["_","PanelCtrl","loadPluginCss","DatasourceUpgrader","dark","light","CallToActionCtrl","$scope","$injector","$location","$q","backendSrv","alertSrv","contextSrv","datasourceSrv","quotas","endpointStatus","collectorStatus","requiresUpgrade","currentlyTrial","aboveFreeTier","getOrgDetails","datasourceUpgrader","panel","snapshotData","endpoint","used","probe","self","dashboard","snapshot","onOrgDetails","org","p","get","then","resp","set","statusText","millionChecksPerMonth","Math","ceil","parseInt","checksPerMonth","strChecksPerMonth","_requiresUpgrade","_currentlyTrial","_aboveFreeTier","wpPlan","onQuotas","meta","code","message","reject","quotaHash","forEach","body","q","target","setEndpointStatus","setCollectorStatus","templateUrl"],"mappings":"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","file":"module.js","sourcesContent":["import _ from 'lodash';\nimport {PanelCtrl} from 'app/plugins/sdk';\nimport {loadPluginCss} from 'app/plugins/sdk';\nimport DatasourceUpgrader from '../../components/config/dsUpgrade';\n\nloadPluginCss({\n  dark: 'plugins/raintank-worldping-app/css/worldping.dark.css',\n  light: 'plugins/raintank-worldping-app/css/worldping.light.css'\n});\n\nclass CallToActionCtrl extends PanelCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, $location, $q, backendSrv, alertSrv, contextSrv, datasourceSrv) {\n    super($scope, $injector);\n    this.backendSrv = backendSrv;\n    this.alertSrv = alertSrv;\n    this.$location = $location;\n    this.$q = $q;\n    this.datasourceSrv = datasourceSrv;\n\n    this.quotas = null;\n    this.endpointStatus = \"scopeEndpoints\";\n    this.collectorStatus = \"scopeCollectors\";\n    this.requiresUpgrade = null;\n    this.currentlyTrial = null;\n    this.aboveFreeTier = null;\n\n    this.getOrgDetails();\n    this.datasourceUpgrader = new DatasourceUpgrader(contextSrv, backendSrv, $q, datasourceSrv);\n    this.panel.snapshotData = this.panel.snapshotData || {};\n  }\n\n  setEndpointStatus() {\n    if (! this.quotas) {\n      return;\n    }\n    if (this.quotas.endpoint.used === 0) {\n      this.endpointStatus = \"noEndpoints\";\n      return;\n    }\n    if (this.quotas.endpoint.used >= 1) {\n      this.endpointStatus = \"hasEndpoints\";\n      return;\n    }\n    //default.\n    this.endpointStatus = \"hasEndpoints\";\n    return;\n  }\n\n  setCollectorStatus() {\n    if (! this.quotas) {\n      return;\n    }\n    if (this.quotas.probe.used === 0) {\n      this.collectorStatus = \"noCollectors\";\n      return;\n    }\n    if (this.quotas.probe.used >= 1) {\n      this.collectorStatus = \"hasCollectors\";\n      return;\n    }\n    //default.\n    this.collectorStatus = \"hasCollectors\";\n    return;\n  }\n\n  getOrgDetails() {\n    var self = this;\n    if(self.dashboard.snapshot){\n      return this.onOrgDetails(self.panel.snapshotData.org);\n    } else {\n      var p = this.backendSrv.get('api/plugin-proxy/raintank-worldping-app/api/grafana-net/profile/org');\n      p.then((resp) => {\n        self.panel.snapshotData.org = resp;\n        self.onOrgDetails(resp);\n      }, (resp) => {\n        self.alertSrv.set(\"failed to get Org Details\", resp.statusText, 'error', 10000);\n      });\n      return p;\n    }\n  }\n\n  onOrgDetails(resp) {\n    var self = this;\n    self.org = resp;\n\n    const millionChecksPerMonth = Math.ceil(parseInt(self.org.checksPerMonth, 10) / 100000) / 10;\n    if (millionChecksPerMonth > 1000) {\n      self.org.strChecksPerMonth = 'using ' + Math.ceil(millionChecksPerMonth / 1000) + ' Billion checks/mo';\n    } else if (millionChecksPerMonth > 0) {\n      self.org.strChecksPerMonth = 'using ' + millionChecksPerMonth + ' Million checks/mo';\n    } else {\n      self.org.strChecksPerMonth = 'not using any checks yet';\n    }\n\n    self.requiresUpgrade = self._requiresUpgrade();\n    self.currentlyTrial = self._currentlyTrial();\n    self.aboveFreeTier = self._aboveFreeTier();\n  }\n\n  _currentlyTrial() {\n    if (!this.org) {\n      return false;\n    }\n\n    if (this.org.wpPlan === 'trial') {\n      return true;\n    }\n\n    return false;\n  }\n\n  _requiresUpgrade() {\n    if (!this.org) {\n      return true;\n    }\n\n    if (this.org.wpPlan !== '' && this.org.wpPlan !== 'free' && this.org.wpPlan !== 'trial') {\n      return false;\n    }\n\n    return true;\n  }\n\n  _aboveFreeTier() {\n    if (!this.org) {\n      return false;\n    }\n\n    if (this.org.wpPlan !== '' && this.org.wpPlan !== 'free') {\n      return false;\n    }\n\n    if (this.org.checksPerMonth / 1000000 > 1) {\n      return true;\n    }\n\n    return false;\n  }\n\n  allDone() {\n    if (! this.quotas) {\n      return false;\n    }\n    if (this.quotas.probe.used === 0) {\n      return false;\n    }\n    if (this.quotas.endpoint.used === 0) {\n      return false;\n    }\n    //default.\n    return true;\n  }\n\n  refresh() {\n    var self = this;\n    if(self.dashboard.snapshot){\n      return this.onQuotas(self.panel.snapshotData.quotas);\n    } else {\n      return this.backendSrv.get('api/plugin-proxy/raintank-worldping-app/api/v2/quotas').then(function(resp) {\n        self.panel.snapshotData.quotas = resp;\n        self.onQuotas(resp);\n      });\n    }\n  }\n\n  onQuotas(resp) {\n    var self = this;\n    if (resp.meta.code !== 200) {\n      self.alertSrv.set(\"failed to get quotas.\", resp.meta.message, 'error', 10000);\n      return self.$q.reject(resp.meta.message);\n    }\n    var quotaHash = {};\n    _.forEach(resp.body, function(q) {\n      quotaHash[q.target] = q;\n    });\n    self.quotas = quotaHash;\n    self.setEndpointStatus();\n    self.setCollectorStatus();\n  }\n}\n\nCallToActionCtrl.templateUrl = 'public/plugins/raintank-worldping-app/panels/call-to-action/module.html';\n\nexport {\n  CallToActionCtrl as PanelCtrl\n};\n"]}